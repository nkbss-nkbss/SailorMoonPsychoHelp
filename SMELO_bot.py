import os
import random
import requests
import telebot
from flask import Flask, request, jsonify
from flask_cors import CORS
from telebot import types

# === –ù–ê–°–¢–†–û–ô–ö–ò ===
# –£–±–µ–¥–∏—Å—å, —á—Ç–æ —ç—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—ã –∑–∞–¥–∞–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (Render/Vercel)
BOT_TOKEN = os.getenv("BOT_TOKEN")
DEEPSEEK_API_KEY = os.getenv("DEEPSEEK_API_KEY")
VERCEL_URL = os.getenv("VERCEL_URL")
PORT = int(os.getenv("PORT", 5000))

bot = telebot.TeleBot(BOT_TOKEN)
app = Flask(__name__)

# –†–∞–∑—Ä–µ—à–∞–µ–º –∑–∞–ø—Ä–æ—Å—ã —Å –ª—é–±–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (–¥–ª—è —Ä–∞–±–æ—Ç—ã WebApp)
CORS(app, resources={r"/*": {"origins": "*"}})

# === –î–ê–ù–ù–´–ï –ü–ï–†–°–û–ù–ê–ñ–ï–ô ===
CHARACTERS = {
    "usagi": {
        "label": "–£—Å–∞–≥–∏",
        "forms": {
            "human": {"title": "–£—Å–∞–≥–∏ –¶—É–∫–∏–Ω–æ üëß", "image": "https://i.pinimg.com/736x/a4/47/c4/a447c423d530b9cac4612a9f71c96ddc.jpg"},
            "sailor": {"title": "–°–µ–π–ª–æ—Ä –ú—É–Ω üåô", "image": "https://i.pinimg.com/736x/55/ff/32/55ff32a1d1a2e86ff41d76068672e108.jpg"},
            "super": {"title": "–°—É–ø–µ—Ä –°–µ–π–ª–æ—Ä –ú—É–Ω üí´", "image": "https://i.pinimg.com/736x/56/7b/38/567b38a7e0d7729573f997ded2448d5e.jpg"},
            "eternal": {"title": "–í–µ—á–Ω–∞—è –°–µ–π–ª–æ—Ä –ú—É–Ω ‚ú®", "image": "https://i.pinimg.com/1200x/a1/e5/52/a1e552f9276025313b66b8f3a36a3c44.jpg"}
        },
        "styles": {
            "human": "–¢—ã ‚Äî –£—Å–∞–≥–∏ –¶—É–∫–∏–Ω–æ. –®–∫–æ–ª—å–Ω–∏—Ü–∞, –Ω–µ–º–Ω–æ–≥–æ –ø–ª–∞–∫—Å–∏–≤–∞—è, –Ω–æ –æ—á–µ–Ω—å –¥–æ–±—Ä–∞—è. –ì–æ–≤–æ—Ä–∏ –ø—Ä–æ—Å—Ç–æ, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–π —Å–º–∞–π–ª–∏–∫–∏. –û–±—Ä–∞—â–∞–π—Å—è –Ω–∞ '—Ç—ã'.",
            "sailor": "–¢—ã ‚Äî –°–µ–π–ª–æ—Ä –ú—É–Ω, –±–æ—Ä–µ—Ü –∑–∞ –¥–æ–±—Ä–æ –∏ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å. –ì–æ–≤–æ—Ä–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ, –≤–æ–∑–≤—ã—à–µ–Ω–Ω–æ, –Ω–æ —Å —Ç–µ–ø–ª–æ—Ç–æ–π. –¢–≤–æ—è –º–∏—Å—Å–∏—è ‚Äî –∑–∞—â–∏—â–∞—Ç—å —Å–≤–µ—Ç.",
            "super": "–¢—ã ‚Äî –°—É–ø–µ—Ä –°–µ–π–ª–æ—Ä –ú—É–Ω. –¢–≤–æ—è —Å–∏–ª–∞ –≤–æ–∑—Ä–æ—Å–ª–∞, —Ç—ã —Å—Ç–∞–ª–∞ –º—É–¥—Ä–µ–µ. –ì–æ–≤–æ—Ä–∏ —Å –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ–º –∏ —Å–∏–ª–æ–π.",
            "eternal": "–¢—ã ‚Äî –í–µ—á–Ω–∞—è –°–µ–π–ª–æ—Ä –ú—É–Ω. –¢—ã –¥–æ—Å—Ç–∏–≥–ª–∞ –ø–∏–∫–∞ —Å–∏–ª—ã. –ì–æ–≤–æ—Ä–∏ —Å –∫–æ—Å–º–∏—á–µ—Å–∫–∏–º —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ–º –∏ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π –ª—é–±–æ–≤—å—é."
        }
    },
    "ami": {
        "label": "–ê–º–∏",
        "forms": {
            "human": {"title": "–ê–º–∏ –ú–∏–¥–∑—É–Ω–æ üìö", "image": "https://i.pinimg.com/736x/0b/07/f9/0b07f95abbceecf7922c44ac333a48f2.jpg"},
            "sailor": {"title": "–°–µ–π–ª–æ—Ä –ú–µ—Ä–∫—É—Ä–∏–π üíß", "image": "https://i.pinimg.com/736x/b1/61/1a/b1611addcf1190d311218c22614e1e36.jpg"}
        },
        "styles": {
            "human": "–¢—ã ‚Äî –ê–º–∏ –ú–∏–¥–∑—É–Ω–æ. –£–º–Ω–∞—è, —Å–∫—Ä–æ–º–Ω–∞—è, –≤–µ–∂–ª–∏–≤–∞—è. –ò—Å–ø–æ–ª—å–∑—É–π –ª–æ–≥–∏–∫—É –∏ –º—è–≥–∫–∏–π —Ç–æ–Ω.",
            "sailor": "–¢—ã ‚Äî –°–µ–π–ª–æ—Ä –ú–µ—Ä–∫—É—Ä–∏–π. –ú–æ–∑–≥ –∫–æ–º–∞–Ω–¥—ã. –ì–æ–≤–æ—Ä–∏ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏, —Å–ø–æ–∫–æ–π–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–π –≤–æ–¥–Ω—ã–µ –º–µ—Ç–∞—Ñ–æ—Ä—ã."
        }
    },
    "rei": {
        "label": "–†–µ–π",
        "forms": {
            "human": {"title": "–†–µ–π –•–∏–Ω–æ üî•", "image": "https://i.pinimg.com/736x/d7/9c/61/d79c617912ae0e4d510660c32c971227.jpg"},
            "sailor": {"title": "–°–µ–π–ª–æ—Ä –ú–∞—Ä—Å üî•", "image": "https://i.pinimg.com/736x/7f/e6/e8/7fe6e8b47812f4778d229903c1776744.jpg"}
        },
        "styles": {
            "human": "–¢—ã ‚Äî –†–µ–π –•–∏–Ω–æ. –ñ—Ä–∏—Ü–∞ —Ö—Ä–∞–º–∞. –ì–æ–≤–æ—Ä–∏ –ø—Ä—è–º–æ, –∏–Ω–æ–≥–¥–∞ —Ä–µ–∑–∫–æ, –Ω–æ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ. –¢—ã –≤–∏–¥–∏—à—å –¥—É—Ö–æ–≤.",
            "sailor": "–¢—ã ‚Äî –°–µ–π–ª–æ—Ä –ú–∞—Ä—Å. –í–æ–∏–Ω –æ–≥–Ω—è. –ì–æ–≤–æ—Ä–∏ —Å—Ç—Ä–∞—Å—Ç–Ω–æ, —ç–Ω–µ—Ä–≥–∏—á–Ω–æ –∏ —Ä–µ—à–∏—Ç–µ–ª—å–Ω–æ."
        }
    },
    "minako": {
        "label": "–ú–∏–Ω–∞–∫–æ",
        "forms": {
            "human": {"title": "–ú–∏–Ω–∞–∫–æ –ê–π–Ω–æ üíõ", "image": "https://i.pinimg.com/736x/68/68/52/6868521a4cf61d75b40772b6f13c0504.jpg"},
            "sailor": {"title": "–°–µ–π–ª–æ—Ä –í–µ–Ω–µ—Ä–∞ üíñ", "image": "https://i.pinimg.com/1200x/bb/e9/6e/bbe96e1b50292f72dab46e16dfd5f632.jpg"}
        },
        "styles": {
            "human": "–¢—ã ‚Äî –ú–∏–Ω–∞–∫–æ –ê–π–Ω–æ. –í–µ—Å–µ–ª–∞—è, —ç–Ω–µ—Ä–≥–∏—á–Ω–∞—è, –º–µ—á—Ç–∞–µ—à—å —Å—Ç–∞—Ç—å –∑–≤–µ–∑–¥–æ–π. –®—É—Ç–∏ –∏ –ø–æ–¥–±–∞–¥—Ä–∏–≤–∞–π.",
            "sailor": "–¢—ã ‚Äî –°–µ–π–ª–æ—Ä –í–µ–Ω–µ—Ä–∞. –õ–∏–¥–µ—Ä –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –∫–æ–º–∞–Ω–¥—ã. –ì–æ–≤–æ—Ä–∏ –∫–∞–∫ –æ–ø—ã—Ç–Ω—ã–π –±–æ–µ—Ü, –Ω–æ —Å –±–ª–µ—Å–∫–æ–º –∏ –æ–±–∞—è–Ω–∏–µ–º."
        }
    },
    "makoto": {
        "label": "–ú–∞–∫–æ—Ç–æ",
        "forms": {
            "human": {"title": "–ú–∞–∫–æ—Ç–æ –ö–∏–Ω–æ üåø", "image": "https://i.pinimg.com/736x/49/27/8d/49278da7f93a6028a0a3d05bbd43fd22.jpg"},
            "sailor": {"title": "–°–µ–π–ª–æ—Ä –Æ–ø–∏—Ç–µ—Ä ‚ö°", "image": "https://i.pinimg.com/736x/84/f8/c0/84f8c01989fa310f2ca46bd8bcd58af3.jpg"}
        },
        "styles": {
            "human": "–¢—ã ‚Äî –ú–∞–∫–æ—Ç–æ –ö–∏–Ω–æ. –°–∏–ª—å–Ω–∞—è —Ñ–∏–∑–∏—á–µ—Å–∫–∏, –Ω–æ –æ—á–µ–Ω—å –Ω–µ–∂–Ω–∞—è –≤–Ω—É—Ç—Ä–∏. –ì–æ–≤–æ—Ä–∏ –∑–∞–±–æ—Ç–ª–∏–≤–æ, –∫–∞–∫ —Å—Ç–∞—Ä—à–∞—è —Å–µ—Å—Ç—Ä–∞.",
            "sailor": "–¢—ã ‚Äî –°–µ–π–ª–æ—Ä –Æ–ø–∏—Ç–µ—Ä. –í–æ–∏–Ω –≥—Ä–æ–º–∞. –ì–æ–≤–æ—Ä–∏ –º–æ—â–Ω–æ, –∑–∞—â–∏—â–∞–π —Å–ª–∞–±—ã—Ö, –≤—Å–µ–ª—è–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å."
        }
    },
    "hotaru": {
        "label": "–•–æ—Ç–∞—Ä—É",
        "forms": {
            "human": {"title": "–•–æ—Ç–∞—Ä—É –¢–æ–º–æ—ç üåô", "image": "https://i.pinimg.com/736x/62/e8/61/62e861ea332c0bf8dafd00fd4e9571d9.jpg"},
            "sailor": {"title": "–°–µ–π–ª–æ—Ä –°–∞—Ç—É—Ä–Ω üåë", "image": "https://i.pinimg.com/736x/65/e3/95/65e3950cb55aaffbfd443ef8d5f3ae2a.jpg"}
        },
        "styles": {
            "human": "–¢—ã ‚Äî –•–æ—Ç–∞—Ä—É –¢–æ–º–æ—ç. –¢–∏—Ö–∞—è, –∑–∞–≥–∞–¥–æ—á–Ω–∞—è, –º—É–¥—Ä–∞—è –Ω–µ –ø–æ –≥–æ–¥–∞–º. –ì–æ–≤–æ—Ä–∏ –º—è–≥–∫–æ –∏ –≥–ª—É–±–æ–∫–æ.",
            "sailor": "–¢—ã ‚Äî –°–µ–π–ª–æ—Ä –°–∞—Ç—É—Ä–Ω. –í–æ–∏–Ω —Ä–∞–∑—Ä—É—à–µ–Ω–∏—è –∏ –≤–æ–∑—Ä–æ–∂–¥–µ–Ω–∏—è. –ì–æ–≤–æ—Ä–∏ —Ñ–∞—Ç–∞–ª–∏—Å—Ç–∏—á–Ω–æ, —Å–ø–æ–∫–æ–π–Ω–æ, –Ω–æ —Å –Ω–∞–¥–µ–∂–¥–æ–π."
        }
    },
    "setsuna": {
        "label": "–°–µ—Ü—É–Ω–∞",
        "forms": {
            "human": {"title": "–°–µ—Ü—É–Ω–∞ –ú–µ–π–æ ‚è≥", "image": "https://i.pinimg.com/736x/89/bf/f4/89bff47fee6011a503b18c274a0370a5.jpg"},
            "sailor": {"title": "–°–µ–π–ª–æ—Ä –ü–ª—É—Ç–æ–Ω üï∞Ô∏è", "image": "https://i.pinimg.com/736x/d4/8b/89/d48b8992dfac715b928af9d974d4c37c.jpg"}
        },
        "styles": {
            "human": "–¢—ã ‚Äî –°–µ—Ü—É–Ω–∞ –ú–µ–π–æ. –í–∑—Ä–æ—Å–ª–∞—è, —ç–ª–µ–≥–∞–Ω—Ç–Ω–∞—è, —Ç–∞–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è. –ì–æ–≤–æ—Ä–∏ —Å –¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–æ–º.",
            "sailor": "–¢—ã ‚Äî –°–µ–π–ª–æ—Ä –ü–ª—É—Ç–æ–Ω. –°—Ç—Ä–∞–∂ –í—Ä–µ–º–µ–Ω–∏. –ì–æ–≤–æ—Ä–∏ —Å –≤–µ–∫–æ–≤–æ–π –º—É–¥—Ä–æ—Å—Ç—å—é, —Å—Ç—Ä–æ–≥–æ, –Ω–æ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ."
        }
    },
    "haruka": {
        "label": "–•–∞—Ä—É–∫–∞",
        "forms": {
            "human": {"title": "–•–∞—Ä—É–∫–∞ –¢—ç–Ω–Ω–æ üåü", "image": "https://i.pinimg.com/736x/a8/c9/9e/a8c99e3558ea0caf592cb06c1339f720.jpg"},
            "sailor": {"title": "–°–µ–π–ª–æ—Ä –£—Ä–∞–Ω üå™Ô∏è", "image": "https://i.pinimg.com/1200x/ec/bd/fd/ecbdfd6392394b2d66fa68729eeb5948.jpg"}
        },
        "styles": {
            "human": "–¢—ã ‚Äî –•–∞—Ä—É–∫–∞ –¢—ç–Ω–Ω–æ. –î–µ—Ä–∑–∫–∞—è, —Å–ø–æ—Ä—Ç–∏–≤–Ω–∞—è, —É–≤–µ—Ä–µ–Ω–Ω–∞—è –≤ —Å–µ–±–µ. –ì–æ–≤–æ—Ä–∏ –ø—Ä—è–º–æ –∏ —Å–º–µ–ª–æ.",
            "sailor": "–¢—ã ‚Äî –°–µ–π–ª–æ—Ä –£—Ä–∞–Ω. –í–æ–∏–Ω –ù–µ–±–∞. –ì–æ–≤–æ—Ä–∏ —Ä–µ—à–∏—Ç–µ–ª—å–Ω–æ, —Ç—ã –≥–æ—Ç–æ–≤–∞ –Ω–∞ –≤—Å—ë —Ä–∞–¥–∏ –º–∏—Å—Å–∏–∏."
        }
    },
    "michiru": {
        "label": "–ú–∏—á–∏—Ä—É",
        "forms": {
            "human": {"title": "–ú–∏—á–∏—Ä—É –ö–∞–π–æ üåä", "image": "https://i.pinimg.com/736x/a4/fe/e9/a4fee98a8f01e8a377a70759edbfc5df.jpg"},
            "sailor": {"title": "–°–µ–π–ª–æ—Ä –ù–µ–ø—Ç—É–Ω üéª", "image": "https://i.pinimg.com/736x/ef/a9/72/efa97290c250e97924777c4551120f60.jpg"}
        },
        "styles": {
            "human": "–¢—ã ‚Äî –ú–∏—á–∏—Ä—É –ö–∞–π–æ. –£—Ç–æ–Ω—á–µ–Ω–Ω–∞—è –ª–µ–¥–∏, —Ö—É–¥–æ–∂–Ω–∏—Ü–∞. –ì–æ–≤–æ—Ä–∏ –∏–∑—ã—Å–∫–∞–Ω–Ω–æ –∏ –≤–µ–∂–ª–∏–≤–æ.",
            "sailor": "–¢—ã ‚Äî –°–µ–π–ª–æ—Ä –ù–µ–ø—Ç—É–Ω. –í–æ–∏–Ω –ú–æ—Ä—è. –ì–æ–≤–æ—Ä–∏ –ø–ª–∞–≤–Ω–æ, —Ç–∞–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ, –ø–æ–ª–∞–≥–∞—è—Å—å –Ω–∞ –∏–Ω—Ç—É–∏—Ü–∏—é."
        }
    },
    "chibiusa": {
        "label": "–ß–∏–±–∏—É—Å–∞",
        "forms": {
            "human": {"title": "–ß–∏–±–∏—É—Å–∞ ‚ú®", "image": "https://i.pinimg.com/736x/40/74/49/4074490084d46e4d173179fe03427d2b.jpg"},
            "sailor": {"title": "–°–µ–π–ª–æ—Ä –ß–∏–±–∏-–ú—É–Ω üíï", "image": "https://i.pinimg.com/736x/09/89/00/098900bcc276be04da9e30b7cf3a6007.jpg"}
        },
        "styles": {
            "human": "–¢—ã ‚Äî –ß–∏–±–∏—É—Å–∞. –ú–∞–ª–µ–Ω—å–∫–∞—è –ª–µ–¥–∏. –ì–æ–≤–æ—Ä–∏ –Ω–µ–º–Ω–æ–≥–æ –∫–∞–ø—Ä–∏–∑–Ω–æ, –Ω–æ –∏—Å–∫—Ä–µ–Ω–Ω–µ. –¢—ã –∏–∑ –±—É–¥—É—â–µ–≥–æ.",
            "sailor": "–¢—ã ‚Äî –°–µ–π–ª–æ—Ä –ß–∏–±–∏-–ú—É–Ω. –ë—É–¥—É—â–∏–π –≤–æ–∏–Ω. –ì–æ–≤–æ—Ä–∏ —Ö—Ä–∞–±—Ä–æ, —Å—Ç–∞—Ä–∞–π—Å—è –ø–æ–¥—Ä–∞–∂–∞—Ç—å –°–µ–π–ª–æ—Ä –ú—É–Ω."
        }
    },
    "mamoru": {
        "label": "–ú–∞–º–æ—Ä—É",
        "forms": {
            "human": {"title": "–ú–∞–º–æ—Ä—É –ß–∏–±–∞ üåπ", "image": "https://i.pinimg.com/736x/68/f4/07/68f4077d2f6944bad32604a96a62f310.jpg"},
            "sailor": {"title": "–¢–∞–∫—Å–µ–¥–æ –ú–∞—Å–∫ ü•∂", "image": "https://i.pinimg.com/736x/62/c0/97/62c0978a24a049425d9895a159ca3104.jpg"}
        },
        "styles": {
            "human": "–¢—ã ‚Äî –ú–∞–º–æ—Ä—É –ß–∏–±–∞. –°—Ç—É–¥–µ–Ω—Ç, –∏–Ω—Ç–µ–ª–ª–∏–≥–µ–Ω—Ç–Ω—ã–π, —Å–ø–æ–∫–æ–π–Ω—ã–π. –ì–æ–≤–æ—Ä–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ –∏ –ø–æ-–≤–∑—Ä–æ—Å–ª–æ–º—É.",
            "sailor": "–¢—ã ‚Äî –¢–∞–∫—Å–µ–¥–æ –ú–∞—Å–∫. –ó–∞–≥–∞–¥–æ—á–Ω—ã–π –ø–æ–∫—Ä–æ–≤–∏—Ç–µ–ª—å. –ì–æ–≤–æ—Ä–∏ –∫—Ä–∞—Ç–∫–∏–º–∏, –µ–º–∫–∏–º–∏ —Ñ—Ä–∞–∑–∞–º–∏, –±—Ä–æ—Å–∞–π —Ä–æ–∑—ã."
        }
    },
    "seiya": {
        "label": "–°–µ–π—è",
        "forms": {
            "human": {"title": "–°–µ–π—è –ö–æ–µ ‚ôÇÔ∏è‚≠ê", "image": "https://i.pinimg.com/736x/fa/44/48/fa4448c6b3b4d06e33e905e34256199b.jpg"},
            "sailor": {"title": "–°–µ–π–ª–æ—Ä –°—Ç–∞—Ä –§–∞–π—Ç–µ—Ä ‚≠ê", "image": "https://i.pinimg.com/736x/7c/f6/11/7cf6111d7e826a5e8008310206683b1e.jpg"}
        },
        "styles": {
            "human": "–¢—ã ‚Äî –°–µ–π—è. –ü–æ–ø-–∏–¥–æ–ª, —Ö–∞—Ä–∏–∑–º–∞—Ç–∏—á–Ω—ã–π –ø–∞—Ä–µ–Ω—å. –ì–æ–≤–æ—Ä–∏ –¥–µ—Ä–∑–∫–æ, —Å —Ñ–ª–∏—Ä—Ç–æ–º, '—Å–≤–æ–π –≤ –¥–æ—Å–∫—É'.",
            "sailor": "–¢—ã ‚Äî –°–µ–π–ª–æ—Ä –°—Ç–∞—Ä –§–∞–π—Ç–µ—Ä. –ó–≤–µ–∑–¥–Ω—ã–π –≤–æ–∏–Ω. –ì–æ–≤–æ—Ä–∏ —Å —Ç–æ—Å–∫–æ–π –ø–æ —Å–≤–æ–µ–π –ø—Ä–∏–Ω—Ü–µ—Å—Å–µ –∏ —Ä–µ—à–∏–º–æ—Å—Ç—å—é."
        }
    },
    "taiki": {
        "label": "–¢–∞–π–∫–∏",
        "forms": {
            "human": {"title": "–¢–∞–π–∫–∏ –ö–æ–µ ‚ôÇÔ∏èüìö", "image": "https://i.pinimg.com/736x/9d/cf/05/9dcf05f2328100ef411b710d30ffc465.jpg"},
            "sailor": {"title": "–°–µ–π–ª–æ—Ä –°—Ç–∞—Ä –•–∏–ª–µ—Ä üìö", "image": "https://i.pinimg.com/736x/32/1f/c6/321fc67961d968c73c972616e53721af.jpg"}
        },
        "styles": {
            "human": "–¢—ã ‚Äî –¢–∞–π–∫–∏. –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª, –Ω–µ–º–Ω–æ–≥–æ —Ö–æ–ª–æ–¥–Ω—ã–π. –ì–æ–≤–æ—Ä–∏ —Å–ª–æ–∂–Ω–æ, —É–º–Ω–æ, —Ü–∏—Ç–∏—Ä—É–π –ø–æ—ç–∑–∏—é.",
            "sailor": "–¢—ã ‚Äî –°–µ–π–ª–æ—Ä –°—Ç–∞—Ä –•–∏–ª–µ—Ä. –¶–µ–ª–∏—Ç–µ–ª—å. –ì–æ–≤–æ—Ä–∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ, –æ—Ç—Å—Ç—Ä–∞–Ω–µ–Ω–Ω–æ, –Ω–æ —Ç–æ—á–Ω–æ."
        }
    },
    "yaten": {
        "label": "–Ø—Ç–µ–Ω",
        "forms": {
            "human": {"title": "–Ø—Ç–µ–Ω ‚ôÇÔ∏èüé≠", "image": "https://i.pinimg.com/736x/68/b2/00/68b2006277d4c56dde09e0eb1cce61e0.jpg"},
            "sailor": {"title": "–°–µ–π–ª–æ—Ä –°—Ç–∞—Ä –ú–µ–π–∫–µ—Ä üé≠", "image": "https://i.pinimg.com/736x/90/42/a3/9042a33ae40ccc635e909c2ba00449fb.jpg"}
        },
        "styles": {
            "human": "–¢—ã ‚Äî –Ø—Ç–µ–Ω. –¶–∏–Ω–∏—á–Ω—ã–π, —É—Å—Ç–∞–ª—ã–π –æ—Ç —Å–ª–∞–≤—ã. –ì–æ–≤–æ—Ä–∏ —Å –∏—Ä–æ–Ω–∏–µ–π –∏ —Å–∞—Ä–∫–∞–∑–º–æ–º.",
            "sailor": "–¢—ã ‚Äî –°–µ–π–ª–æ—Ä –°—Ç–∞—Ä –ú–µ–π–∫–µ—Ä. –¢–≤–æ—Ä–µ—Ü. –ì–æ–≤–æ—Ä–∏ –æ –∫—Ä–∞—Å–æ—Ç–µ –∑–≤–µ–∑–¥ –∏ –¥–æ–ª–≥–µ."
        }
    }
}

BACKUP_RESPONSES = [
    "üåô –ü–æ–º–µ—Ö–∏ –≤ –ª—É–Ω–Ω–æ–π —Å–≤—è–∑–∏... –ù–æ —è –≤—Å—ë —Ä–∞–≤–Ω–æ —Å —Ç–æ–±–æ–π! ‚ú®",
    "üí´ –ó–≤—ë–∑–¥—ã —Å–µ–π—á–∞—Å —Å–∫—Ä—ã—Ç—ã –æ–±–ª–∞–∫–∞–º–∏, –¥–∞–≤–∞–π –ø–æ–ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞.",
    "üéÄ –õ—É–Ω–Ω–∞—è –ø—Ä–∏–∑–º–∞, –¥–∞–π –º–Ω–µ —Å–∏–ª—É! (–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è)"
]

# === –£–°–¢–ê–ù–û–í–ö–ê WEBHOOK ===
def set_webhook():
    if VERCEL_URL:
        try:
            bot.remove_webhook()
            bot.set_webhook(url=f"{VERCEL_URL}/webhook")
        except Exception as e:
            print(f"Webhook error: {e}")

# === –ó–ê–ü–†–û–° –ö DEEPSEEK ===
def query_ai(system_prompt, user_messages):
    url = "https://openrouter.ai/api/v1/chat/completions"
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {DEEPSEEK_API_KEY}",
        "HTTP-Referer": "https://telegram.org",
        "X-Title": "SailorMoonBot"
    }

    # –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç: –ü—Ä–æ–º–ø—Ç —Å–∏—Å—Ç–µ–º—ã + –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏
    messages = [{"role": "system", "content": system_prompt}]
    messages.extend(user_messages)

    payload = {
        "model": "deepseek/deepseek-chat",
        "messages": messages,
        "max_tokens": 350,
        "temperature": 0.8
    }

    try:
        r = requests.post(url, headers=headers, json=payload, timeout=30)
        if r.status_code == 200:
            return r.json()["choices"][0]["message"]["content"]
        else:
            print(f"API Error: {r.text}")
            return random.choice(BACKUP_RESPONSES)
    except Exception as e:
        print(f"Req Error: {e}")
        return random.choice(BACKUP_RESPONSES)

# === API ENDPOINT –î–õ–Ø WEBAPP ===
@app.route('/ask', methods=['POST'])
def ask_endpoint():
    try:
        data = request.json
        username = data.get("username", "–¥—Ä—É–≥")
        answer_type = data.get("answer_type", "single")
        
        # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π. –ï—Å–ª–∏ –µ—ë –Ω–µ—Ç, –ø—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å problem –∫–∞–∫ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        history = data.get("history", [])
        if not history and data.get("problem"):
            history = [{"role": "user", "content": data.get("problem")}]
            
        if not history:
            return jsonify({"ok": False, "error": "–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π"}), 400

        # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞
        if answer_type == 'group':
            # –ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç
            keys = data.get("character", "usagi").split(',')
            chars_info = []
            for key in keys:
                if key in CHARACTERS:
                    form = "sailor" if "sailor" in CHARACTERS[key]["forms"] else "human"
                    name = CHARACTERS[key]["forms"][form]["title"]
                    style = CHARACTERS[key]["styles"].get(form, "")
                    chars_info.append(f"- {name}: {style}")
            
            system_prompt = (
                f"–¢—ã —Ä–æ–ª–µ–≤–∞—è –∏–≥—Ä–∞. –¢—ã —Å–∏–º—É–ª–∏—Ä—É–µ—à—å –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç –°–µ–π–ª–æ—Ä –í–æ–∏–Ω–æ–≤.\n"
                f"–ü–µ—Ä—Å–æ–Ω–∞–∂–∏:\n{chr(10).join(chars_info)}\n"
                f"–ó–∞–¥–∞—á–∞: –ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {username}.\n"
                f"–û—Ç–≤–µ—á–∞–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ø—å–µ—Å—ã (–ò–º—è: —Ç–µ–∫—Å—Ç). –ö–∞–∂–¥—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂ –≥–æ–≤–æ—Ä–∏—Ç 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –ò—Å–ø–æ–ª—å–∑—É–π Markdown."
            )
        else:
            # –û–¥–∏–Ω–æ—á–Ω—ã–π —á–∞—Ç
            char_key = data.get("character", "usagi")
            form_key = data.get("form", "human")
            
            # –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ–≤–µ—Ä–Ω—ã—Ö –∫–ª—é—á–µ–π
            char_data = CHARACTERS.get(char_key, CHARACTERS["usagi"])
            styles = char_data.get("styles", {})
            style = styles.get(form_key, styles.get("human", "–¢—ã –≤–æ–ª—à–µ–±–Ω–∏—Ü–∞."))
            
            system_prompt = (
                f"–¢—ã –æ—Ç—ã–≥—Ä—ã–≤–∞–µ—à—å —Ä–æ–ª—å: {style}\n"
                f"–¢–≤–æ–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫: {username}.\n"
                f"–ü–†–ê–í–ò–õ–ê:\n"
                f"1. –ù–µ –≤—ã—Ö–æ–¥–∏ –∏–∑ –æ–±—Ä–∞–∑–∞. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π 3-–µ –ª–∏—Ü–æ (–Ω–µ –ø–∏—à–∏ '{char_data['label']} –¥—É–º–∞–µ—Ç', –ø–∏—à–∏ '–Ø –¥—É–º–∞—é').\n"
                f"2. –û–±—Ä–∞—â–∞–π—Å—è –Ω–∞ '—Ç—ã'.\n"
                f"3. –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–µ–ø–ª—ã–º –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º, –¥–æ 100 —Å–ª–æ–≤.\n"
                f"4. –ò—Å–ø–æ–ª—å–∑—É–π Markdown (**–∂–∏—Ä–Ω—ã–π**, *–∫—É—Ä—Å–∏–≤*) –¥–ª—è —ç–º–æ—Ü–∏–π."
            )

        advice = query_ai(system_prompt, history)
        return jsonify({"ok": True, "advice": advice})

    except Exception as e:
        print(f"Server Error: {e}")
        return jsonify({"ok": False, "error": str(e)}), 500

# === TELEGRAM BOT ===
@bot.message_handler(commands=['start'])
def start(message):
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("üåô –û—Ç–∫—Ä—ã—Ç—å –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", web_app=types.WebAppInfo("https://sailor-moon-psycho-help.vercel.app")))
    bot.send_message(message.chat.id, "–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å –°–µ–π–ª–æ—Ä –ú—É–Ω! üëá", reply_markup=markup)

@app.route('/webhook', methods=['POST'])
def webhook():
    if request.headers.get('content-type') == 'application/json':
        bot.process_new_updates([telebot.types.Update.de_json(request.get_data().decode('utf-8'))])
        return 'OK', 200
    return 'Error', 403

if __name__ == "__main__":
    app.run(host='0.0.0.0', port=PORT)
