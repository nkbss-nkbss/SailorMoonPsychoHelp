<!-- index.html -->
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sailor Moon ‚Äî Mini App</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>üåô Sailor Moon ‚Äî –õ—É–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞</h1>
      <p class="subtitle">–ò–º—è ‚Üí –ü–µ—Ä—Å–æ–Ω–∞–∂ ‚Üí –ü—Ä–æ–±–ª–µ–º–∞ ‚Üí –°–æ–≤–µ—Ç</p>
    </header>

    <main>
      <section id="step-name" class="card active">
        <h2>–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?</h2>
        <input id="input-name" placeholder="–í–≤–µ–¥–∏ –∏–º—è" maxlength="50" />
        <div class="row">
          <button id="btn-name-next" class="btn">–î–∞–ª—å—à–µ ‚Üí</button>
        </div>
      </section>

      <section id="step-character" class="card">
        <h2>–í—ã–±–µ—Ä–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h2>
        <div id="characters" class="cards-grid"></div>
        <div class="row">
          <button id="btn-char-back" class="btn outline">‚Üê –ù–∞–∑–∞–¥</button>
          <button id="btn-char-next" class="btn">–î–∞–ª—å—à–µ ‚Üí</button>
        </div>
      </section>

      <section id="step-problem" class="card">
        <h2>–†–∞—Å—Å–∫–∞–∂–∏, —á—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å</h2>
        <textarea id="input-problem" rows="6" placeholder="–û–ø–∏—à–∏ –ø—Ä–æ–±–ª–µ–º—É..."></textarea>
        <div class="row">
          <button id="btn-problem-back" class="btn outline">‚Üê –ù–∞–∑–∞–¥</button>
          <button id="btn-problem-send" class="btn primary">–ü–æ–ª—É—á–∏—Ç—å —Å–æ–≤–µ—Ç ‚ú®</button>
        </div>
      </section>

      <section id="step-result" class="card">
        <h2>–°–æ–≤–µ—Ç</h2>
        <div id="result-box" class="result"></div>
        <div class="row">
          <button id="btn-result-again" class="btn outline">–ó–∞–¥–∞—Ç—å –µ—â—ë –≤–æ–ø—Ä–æ—Å</button>
          <button id="btn-result-close" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </section>
    </main>

    <footer>
      <small>Mini App ‚Ä¢ Sailor Moon style ‚ú®</small>
    </footer>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    let state = { name: '', character: '', problem: '' };
    const characters = [
      "usagi","ami","rei","minako","makoto",
      "hotaru","setsuna","haruka","michiru","chibiusa","mamoru"
    ];

    const $ = (id) => document.getElementById(id);

    // Step navigation
    const showStep = (step) => {
      document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
      $(step).classList.add('active');
    };

    // Step 1 ‚Üí Step 2
    $('btn-name-next').onclick = () => {
      const name = $('input-name').value.trim();
      if(name.length < 2){ alert('–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞'); return; }
      state.name = name;
      showStep('step-character');
    };

    // Step 2 ‚Üí Step 3
    $('btn-char-next').onclick = () => {
      if(!state.character){ alert('–í—ã–±–µ—Ä–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞'); return; }
      showStep('step-problem');
    };
    $('btn-char-back').onclick = () => showStep('step-name');

    // Step 3 ‚Üí Step 4 (send request)
    $('btn-problem-send').onclick = async () => {
      const problem = $('input-problem').value.trim();
      if(!problem){ alert('–û–ø–∏—à–∏ –ø—Ä–æ–±–ª–µ–º—É'); return; }
      state.problem = problem;
      showStep('step-result');
      $('result-box').innerText = 'üåï –û–±–¥—É–º—ã–≤–∞—é –æ—Ç–≤–µ—Ç... üí´';

      try {
        const resp = await fetch('/ask', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(state)
        });
        const data = await resp.json();
        if(data.ok){
          $('result-box').innerText = data.advice;
        } else {
          $('result-box').innerText = '‚ùå –û—à–∏–±–∫–∞: ' + data.error;
        }
      } catch(e){
        $('result-box').innerText = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
      }
    };
    $('btn-problem-back').onclick = () => showStep('step-character');

    // Step 4 ‚Üí restart
    $('btn-result-again').onclick = () => {
      $('input-problem').value = '';
      showStep('step-problem');
    };
    $('btn-result-close').onclick = () => tg.close();
    
    // Render character buttons
    const charsDiv = $('characters');
    characters.forEach(c => {
      const btn = document.createElement('button');
      btn.className = 'btn outline';
      btn.innerText = c;
      btn.onclick = () => {
        state.character = c;
        Array.from(charsDiv.children).forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
      };
      charsDiv.appendChild(btn);
    });
  </script>
</body>
</html>
